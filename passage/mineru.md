# 医疗检验单 OCR 结构化识别流程报告（MinerU）

##  背景与目标

本项目目标是对医疗检验单（以“血生化”等检验报告为主，包含图片型 PDF / 扫描件）进行 OCR 与版面/表格结构化解析，输出可用于后续数据处理与归一化的中间结果（JSON/Markdown/PDF 可视化等）。

本报告覆盖从服务器部署、环境配置、模型下载、（可选）方向纠正，到 MinerU 推理输出与质量评估的完整流程，确保可复现。

------

##  运行环境与约束

- GPU/CUDA：服务器 CUDA 版本 **12.2**
- Python：**3.10**
- 部署约束：推荐在指定目录下管理环境与数据（例如 `/data/jupyter/lzh/`）

> 说明：PyTorch 官方提供的 CUDA wheel 通常按 `cu121`/`cu124` 等发布。即使服务器 CUDA 为 12.2，安装 `cu121` 的 PyTorch wheel 一般仍可正常工作（前提是驱动满足要求）。本项目采用 `cu121` 版本。

------

##  部署与环境配置（Conda 自定义路径）

###  配置 conda 环境路径

将 conda 环境目录统一放到自定义路径，便于权限隔离与磁盘管理：

```
conda config --add envs_dirs <path>
```

### 创建/启用虚拟环境

创建 Python 3.10 环境：

```
conda create -y -n mineru python=3.10
```

激活环境：

```
（服务器上可直接使用已创建环境）⬇️使用这个环境可以直接跳转第六步
conda activate /data/jupyter/lzh/conda_envs/mineru_py310
```

------

## MinerU 安装与验证

### 安装包管理工具与 MinerU

```
# 1) 安装 uv（更快、更稳定的 pip 前端）
pip install uv

# 2) 清理旧版本（避免依赖冲突）
pip uninstall mineru -y

# 3) 安装 MinerU 完整版本（使用镜像源）
uv pip install -U "mineru[core]" -i https://mirrors.aliyun.com/pypi/simple
```

###  安装 PyTorch（GPU）

CUDA 12.2 环境下，使用 cu121 的 PyTorch wheel：

```
pip install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 \
  --index-url https://download.pytorch.org/whl/cu121
```

### 安装完成验证

```
# 查看版本信息
mineru --version

# 查看帮助信息
mineru --help
```

若能正常输出版本号与帮助信息，说明 MinerU CLI 可用、依赖加载正常。

------

## 模型文件下载与管理

###  自动下载（推荐）

MinerU 需要下载模型文件才能执行版面分析、OCR 与结构化解析：

```
# 下载所有必要模型（约 8–12GB，视版本而定）
mineru-models-download --model_type all
```

###  注意事项

- 首次下载耗时较长，取决于网络与磁盘 IO。
- 下载失败可重试；模型更新通常为增量更新。
- 默认缓存路径在 `root/.cache`。官方目前不支持指定路径下载！
- 如需迁移模型目录：可将模型文件夹移动到其他位置，并在 `mineru.json` 中更新模型路径（避免重复下载）。

------

## 数据预处理（可选）：方向纠正（仅在存在方向错误时启用）

###  说明

在图片型 PDF / 扫描件中，存在部分样本方向不一致（如 90/180/270°）。实践对比表明，自动旋转/启发式旋转在该类表格类文档上容易误判，因此采用“人工标注角度 + 脚本批量应用”的方式更稳健。

若数据集方向全部正确，可跳过本节。

###  脚本：生成待标注清单（gen）

执行：

```
python 手动纠正方向脚本.py gen \
  --input <存放PDF/图片的文件夹路径> \
  --csv <输出CSV路径>
```

脚本将生成 CSV 清单。需要在 CSV 的 `chosen_cw` 列填写旋转角度（顺时针）：

- 90 / 180 / 270
- 留空表示不旋转（默认保持原样）

###  脚本：批量应用旋转（apply）

```
python 手动纠正方向脚本.py apply \
  --input <原始数据路径> \
  --output <纠正后输出路径> \
  --csv <CSV路径> \
  --logdir <日志目录> \
  --pdf-scale-apply 2.0
```

**参数说明：**

- `--input`：原始数据目录
- `--output`：纠正后输出目录（建议与原始目录分离，便于回滚）
- `--csv`：人工填好的旋转清单
- `--logdir`：执行日志输出
- `--pdf-scale-apply`：对 PDF 渲染/旋转时的缩放倍率（影响质量与速度，一般 1.5–2.0 足够）

------

##  MinerU 批量识别

###  文件识别命令

```
mineru -p <input_path> -o <output_path> --source local --device cuda
```

**关键点：**

- `<input_path>`：应指向 **纠正方向后** 的数据路径（如执行了第 6 节）
- `--device cuda`：启用 GPU 推理（需要 torch 与驱动正常）

###  性能参考（经验值）

在单卡 GPU 上，平均耗时约为“每份文件 ~1 分钟量级”（与 PDF 页数、分辨率、表格密度、GPU 型号、并发设置等强相关）。建议以实际跑出来的吞吐为准，并在批量阶段记录日志与失败清单。

------

## 输出文件说明（以单份样本为例）

MinerU 对每份输入通常会输出以下内容：

- **images/**：解析过程生成的页面图或中间图（用于可视化与调试）。
- ***_origin.pdf**：原始输入的副本或标准化副本（用于回溯比对）。
- ***_layout.pdf**：版面解析可视化结果（常包含检测框/区域划分等），用于快速肉眼检查“表格/文字块是否定位正确”。
- ***_middle.json**：关键中间结构化结果：通常包含页面结构、块级内容、表格候选、文本段等，是后续“抽取检验项目/结果/单位/参考区间”的主要依据。
- ***_model.json**：模型推理相关的结构信息/元信息，用于调试或复现实验环境。
- ***_content_list.json**、***_content_list_v2.json**：内容列表（按块/段/表格等组织），通常是从 `middle.json` 派生出的结构，便于直接遍历抽取。
- ***.md**：将识别结果以 Markdown 形式输出（便于人工阅读核对）。

------

## 质量评估与验收方式

### 评估策略（当前采用）

由于数据为真实医疗检验单，版式差异较大，当前采用“人工抽样质检”作为主评估方式：

1. 随机抽取一定比例样本（例如 5%–10%）
2. 对照 `*_layout.pdf` 与 `*.md/middle.json`：
   - 表格区域是否定位正确
   - 关键字段（项目、结果、单位、参考区间）是否齐全
   - 明显 OCR 错误是否存在

------

##  结论与后续工作

1. 完成了 MinerU 的 GPU 环境部署、模型下载与可复现的推理流程。
2. 对存在方向错误的数据，采用“人工标注角度 + 脚本批量应用”的方式，显著提升识别稳定性。
3. MinerU 输出的 `middle.json` 可作为后续“检验项目归一化”的数据入口。

**下一步（建议）：**

- 编写统一的字段抽取脚本：输出结构化表（CSV/JSONL）。
- 建立“跨医院项目归一化”字典与映射规则。
- 增加轻量量化评估指标。